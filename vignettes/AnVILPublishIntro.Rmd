---
title: "Publishing R / Bioconductor Packages To AnVIL Workspaces"
author:
- name: Martin Morgan
  affiliation: Roswell Park Comprehensive Cancer Center
  email: Martin.Morgan@RoswellPark.org
package: AnVILPublish
output:
  BiocStyle::html_document
abstract: |
  This vignette introduces the AnVILPublish package for transforming R / 
  Bioconductor packages to AnVIL workspaces. Data from the package 
  DESCRIPTION file and vignette YAML chunks are used to create the 'DASHBOARD'
  workspace landing page. Vignettes are processed to Python notebooks and added
  to the workspace bucke for access via the 'NOTEBOOKS' tab.
vignette: |
  %\VignetteIndexEntry{Publishing R / Bioconductor packages to AnVIL Workspaces}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This package produces AnVIL workspaces from R packages. An example
uses the new [Gen3][4] package as a basis for the
[Bioconductor-Package-Gen3][3] workspace (permission to access this
workspace is required, but there are no restrictions on granting
permission).

[4]: https://github.com/Bioconductor/Gen3
[3]: https://anvil.terra.bio/#workspaces/bioconductor-rpci-anvil/Bioconductor-Package-Gen3

## Package installation

If necessary, install the AnVILPublish library

```{r}
if (!"AnVILPublish" %in% rownames(installed.packages()))
    BiocManager::install("Bioconductor/AnVILPublish")
```

There are only a small number of functions in the package; it is
likely best practice to invoke these using `AnVILPublish::...()`
rather than attaching the package to the search path.

## The `gcloud` SDK

It is necessary to have the [gcloud SDK][1] available to copy notebook
files to the workspace. Test availability with

```{r, eval = FALSE}
AnVIL::gcloud_exists()
```

and verify that the account and project are appropriate (consistent
with AnVIL credentials) for use with AnVIL

```{r, eval = FALSE}
AnVIL::gcloud_account()
AnVIL::gcloud_project()
```

Note that these be used to set, as well as interrogate, the acount and project.

[1]: https://cloud.google.com/sdk

## `notedown` software

Conversion of .Rmd vignettes to .ipynb notebooks uses [notedown][2]
python software. It must be available from within _R_, e.g.,

```{r, eval = FALSE}
system2("notedown", "--version")
```

[2]: https://github.com/aaren/notedown

# Creating or updating workspaces

**CAUTION** updating an existing workspace will replace existing
content in a way that cannot be undone -- you will lose content!

Workspace creation or update uses information from the DESCRIPTION
file, and from the YAML metadata at the top of vignettes. It is
therefore worth-while to make sure this information is accurate.

In the DESCRIPTION file, the Title, Version, Authors\@R (preferred) or
Author / Maintainer fields, Description, and License fields are used.

In vignettes, the title: and author: name: fields are used; the
abstract is a good candidate for future inclusion.

## From package source

The one-stop route is to create a workspace from the package source
(e.g., github checkout) directory use `as_workspace()`.

```{r, eval = FALSE}
AnVILPublish::as_workspace(
    "path/to/package",
    "bioconductor-rpci-anvil",     # i.e., billing account
    create = TRUE                  # use update = TRUE for an existing workspace
)
```

Use `create = TRUE` to create a new workspace. Use `update = TRUE` to
update (and potentially overwrite) an existing workspace. One of
`create` and `update` must be TRUE. The command illustrated above does
not specify the `name =` argument, so creates or updates a workspace
`"Bioconductor-Package-<pkgname>`, where `<pkgname>` is the name of
the package read from the DESCRIPTION file; provide an explict name to
create or update an arbitrary workspace.

`AnVILPublish::as_workspace()` invokes `as_notebook()` and
`add_user()`, so these steps do not need to be performed 'by hand'.

## Updating workspace notebooks from vignettes

Transforming vignettes to notebooks may require several iterations,
and is available as a separate operation. Use `update = FALSE` to
create local copies for preview.

```{r, eval = FALSE}
AnVIL::Publish::as_notebook(
    "path/to/package",
    "bioconductor-rpci-anvil",     # i.e., billing account
    "Bioconductor-Package-Foo",    # Workspace name
    update = FALSE                 # make notebooks, but do not update workspace
)
```

The vignette transformation process has several limitations. Only
`.Rmd` vignettes are supported. Currently, the vignette is transformed
first to a markdown document using the `rmarkdown` command
`render(..., md_document())`.  The markdown document is then
translated to python notebook using `notedown`.

Because the input to notedown is a plain markdown document, any
annotations on the code chunks (e.g., `eval = FALSE`) have been lost
-- it will appear in the notebook that all code chunks are to be
evaluated. This could be very problematic if the unevaluated code
chunks were meant to illustrate destructive actions like file removal.

Because the Rmd document has been evaluated, it includes output from
the evaluated cells. This will likely be confusing to the user. One
approach migth use environment variables to set all cells to `eval =
FALSE` during the rendering phase.

It is likely that some of the limitations of vignette rendering can be
reduced.

## Adding user access credentiials to share the notebook

The `"Bioconductor_User"` group can be added to the entities that can
see the workspace. AnVIL users wishing to view the worksppace should
be added to the `Bioconductor_User` group, rather than to the
workspace directly. To add the user group, use

```{r, eval = FALSE}
AnVILPublish::add_user(
    "bioconductor-rpci-anvil",
    "Bioconductor-Package-Foo"
)
```

# Session info {.unnumbered}

```{r sessionInfo}
sessionInfo()
```
